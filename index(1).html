<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .subject-card { margin-bottom: 1rem; }
    .subtopic { padding: 0.5rem; border-bottom: 1px solid #ddd; }
    .completed { text-decoration: line-through; color: gray; }
    .revision-card { margin-bottom: 0.5rem; }
    .stopwatch-display { font-size: 1.3rem; font-weight: bold; color: #0d6efd; }
  </style>
</head>
<body class="p-4">

<div class="container">
  <h2 class="mb-4 text-center">üìö Study & Revision Tracker</h2>

  <!-- Top Buttons -->
  <div class="d-flex gap-2 justify-content-center mb-4">
    <button class="btn btn-outline-success btn-sm" onclick="exportData()">‚¨áÔ∏è Export JSON</button>
    <input type="file" id="importFile" class="d-none" accept=".json" onchange="importData(event)">
    <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import JSON</button>
    <button class="btn btn-outline-danger btn-sm" onclick="resetData()">üóë Reset All</button>
    <button class="btn btn-outline-info btn-sm" onclick="saveOnline()">‚òÅÔ∏è Save Online</button>
    <button class="btn btn-outline-dark btn-sm" onclick="loadOnline()">‚òÅÔ∏è Load Online</button>

  </div>

  <div class="row g-4">
    <!-- Subjects Column -->
    <div class="col-lg-6">
      <div class="card p-3 mb-4 shadow-sm">
        <h5>Add Subject</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <input id="subjectName" type="text" class="form-control" placeholder="Subject name">
          </div>
          <div class="col-md-4">
            <input id="subjectTime" type="number" class="form-control" placeholder="Total time (hrs)">
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="addSubject()">Add</button>
          </div>
        </div>
      </div>
      <div id="subjectsContainer"></div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-6">

      <div class="card p-3 mb-3 shadow-sm">
        <h5>‚è±Ô∏è Stopwatch Study Time (Today)</h5>
        <div id="stopwatchTime" class="stopwatch-display">00:00:00</div>
      </div>

      <div class="card p-3 mb-3 shadow-sm">
        <h5>üìÖ Daily Completed Topics</h5>
        <div id="dailyProgress"></div>
      </div>

      <div class="card p-3 mb-3 shadow-sm">
        <h5>üîÅ Revision - Today</h5>
        <div id="revisionToday"></div>
      </div>

      <div class="card p-3 mb-3 shadow-sm">
        <h5>‚ö†Ô∏è Missed Revisions</h5>
        <div id="missedRevisions"></div>
      </div>

      <div class="card p-3 mb-3 shadow-sm">
        <h5>‚úÖ Completed Revisions (History)</h5>
        <div id="revisionHistory"></div>
      </div>
    </div>
  </div>
</div>

<!-- Completion Modal -->
<div class="modal fade" id="completionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Mark Subtopic Completed</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label>Enter time spent (hours & minutes):</label>
        <div class="row g-2 mt-2">
          <div class="col">
            <input type="number" id="timeHours" class="form-control" placeholder="Hours" min="0">
          </div>
          <div class="col">
            <input type="number" id="timeMinutes" class="form-control" placeholder="Minutes" min="0" max="59">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="confirmCompletion()">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let subjects = JSON.parse(localStorage.getItem("subjects")) || [];
  let dailyLog = JSON.parse(localStorage.getItem("dailyLog")) || {};
  let revisionHistory = JSON.parse(localStorage.getItem("revisionHistory")) || {};
  let stopwatchLog = JSON.parse(localStorage.getItem("stopwatchLog")) || {};
  let selectedSubtopic = null;

  function saveData() {
    localStorage.setItem("subjects", JSON.stringify(subjects));
    localStorage.setItem("dailyLog", JSON.stringify(dailyLog));
    localStorage.setItem("revisionHistory", JSON.stringify(revisionHistory));
    localStorage.setItem("stopwatchLog", JSON.stringify(stopwatchLog));
  }

  function addSubject() {
    const name = document.getElementById("subjectName").value.trim();
    const time = parseFloat(document.getElementById("subjectTime").value);
    if (!name || isNaN(time) || time <= 0) return alert("Enter valid subject and time");

    subjects.push({ id: Date.now(), name, totalTime: time*3600, remainingTime: time*3600, subtopics: [] });
    saveData();
    renderAll();
    document.getElementById("subjectName").value = "";
    document.getElementById("subjectTime").value = "";
  }

  function addSubtopic(subjectId) {
    const subName = prompt("Enter subtopic name:");
    if (!subName) return;
    const subject = subjects.find(s => s.id === subjectId);
    subject.subtopics.push({
      id: Date.now(), name: subName, timeSpent: 0, running: false,
      completed: false, completedDate: null, timer: null, revisions: []
    });
    saveData();
    renderAll();
  }

  function formatTimeHMS(seconds) {
    const h = String(Math.floor(seconds/3600)).padStart(2,"0");
    const m = String(Math.floor((seconds%3600)/60)).padStart(2,"0");
    const s = String(seconds%60).padStart(2,"0");
    return `${h}:${m}:${s}`;
  }

  function toggleTimer(subjectId, subId) {
    const subject = subjects.find(s => s.id === subjectId);
    const sub = subject.subtopics.find(st => st.id === subId);

    if (sub.completed) return; // do not allow start if completed

    if (!sub.running) {
      sub.running = true;
      sub.timer = setInterval(() => {
        sub.timeSpent++;
        subject.remainingTime = Math.max(0, subject.remainingTime-1);

        // add to today's stopwatch log
        let today = new Date().toISOString().split("T")[0];
        if (!stopwatchLog[today]) stopwatchLog[today] = 0;
        stopwatchLog[today]++;

        saveData();
        updateLiveStopwatch(subjectId, subId); // live update
      }, 1000);
    } else {
      sub.running = false;
      clearInterval(sub.timer);
      sub.timer = null;
    }
    saveData();
    renderAll();
  }

  function updateLiveStopwatch(subjectId, subId) {
    const sub = subjects.find(s => s.id === subjectId).subtopics.find(st => st.id === subId);
    const elem = document.getElementById(`time-${sub.id}`);
    if (elem) elem.innerText = formatTimeHMS(sub.timeSpent);

    // update total stopwatch today
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("stopwatchTime").innerText = formatTimeHMS(stopwatchLog[today] || 0);
  }

  function openCompletion(subjectId, subId) {
    selectedSubtopic = {subjectId, subId};
    document.getElementById("timeHours").value = "";
    document.getElementById("timeMinutes").value = "";
    new bootstrap.Modal(document.getElementById("completionModal")).show();
  }

  function confirmCompletion() {
    if (!selectedSubtopic) return;
    const {subjectId, subId} = selectedSubtopic;
    const subject = subjects.find(s => s.id === subjectId);
    const sub = subject.subtopics.find(st => st.id === subId);

    let hrs = parseInt(document.getElementById("timeHours").value)||0;
    let mins = parseInt(document.getElementById("timeMinutes").value)||0;
    let seconds = hrs*3600 + mins*60;

    sub.timeSpent += seconds;
    subject.remainingTime = Math.max(0, subject.remainingTime-seconds);
    sub.completed = true;
    sub.completedDate = new Date().toISOString().split("T")[0];

    let today = sub.completedDate;
    if (!dailyLog[today]) dailyLog[today] = [];
    dailyLog[today].push({subject: subject.name, subtopic: sub.name});

    // schedule revision dates
    let compDate = new Date(sub.completedDate);
    let day3 = new Date(compDate); day3.setDate(day3.getDate()+3);
    let day7 = new Date(compDate); day7.setDate(day7.getDate()+7);
    sub.revisions = [
      {date: day3.toISOString().split("T")[0], done: false},
      {date: day7.toISOString().split("T")[0], done: false}
    ];

    saveData();
    bootstrap.Modal.getInstance(document.getElementById("completionModal")).hide();
    renderAll();
  }

  function markRevisionDone(subjectId, subId, date) {
    const subject = subjects.find(s => s.id === subjectId);
    const sub = subject.subtopics.find(st => st.id === subId);
    const rev = sub.revisions.find(r => r.date===date);
    if (rev) rev.done = true;

    if (!revisionHistory[date]) revisionHistory[date] = [];
    revisionHistory[date].push({subject: subject.name, subtopic: sub.name});

    saveData();
    renderAll();
  }

  function renderSubjects() {
    const container = document.getElementById("subjectsContainer");
    container.innerHTML = "";
    subjects.forEach(sub => {
      const percent = sub.totalTime>0 ? ((sub.totalTime-sub.remainingTime)/sub.totalTime*100).toFixed(1) : 0;
      const card = document.createElement("div");
      card.className = "card subject-card shadow-sm";
      card.innerHTML = `
        <div class="card-body">
          <h5>${sub.name} 
            <span class="badge bg-secondary">Remaining: ${formatTimeHMS(sub.remainingTime)}</span>
          </h5>
          <div class="progress mb-2">
            <div class="progress-bar" style="width:${percent}%">${percent}%</div>
          </div>
          <button class="btn btn-sm btn-outline-primary mb-2" onclick="addSubtopic(${sub.id})">+ Add Subtopic</button>
          <div>
            ${sub.subtopics.map(st => `
              <div class="subtopic d-flex justify-content-between ${st.completed?'completed':''}">
                <span>${st.name} - <small id="time-${st.id}">${formatTimeHMS(st.timeSpent)}</small></span>
                <div>
                  ${!st.completed ? `
                    <button class="btn btn-sm ${st.running?'btn-danger':'btn-success'}" onclick="toggleTimer(${sub.id}, ${st.id})">${st.running?'Stop':'Start'}</button>
                    <button class="btn btn-sm btn-warning" onclick="openCompletion(${sub.id}, ${st.id})">Complete</button>
                  ` : ""}
                </div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function renderDailyLog() {
    const container = document.getElementById("dailyProgress");
    container.innerHTML = "";
    Object.keys(dailyLog).sort().forEach(date => {
      const div = document.createElement("div");
      div.className = "mb-2";
      div.innerHTML = `<strong>${date}</strong><ul>${dailyLog[date].map(item=>`<li>${item.subject} - ${item.subtopic}</li>`).join("")}</ul>`;
      container.appendChild(div);
    });
  }

  function renderStopwatchLog() {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("stopwatchTime").innerText = formatTimeHMS(stopwatchLog[today] || 0);
  }

  function renderRevision() {
    const today = new Date().toISOString().split("T")[0];
    const todayContainer = document.getElementById("revisionToday");
    const missedContainer = document.getElementById("missedRevisions");
    const historyContainer = document.getElementById("revisionHistory");

    todayContainer.innerHTML = "";
    missedContainer.innerHTML = "";
    historyContainer.innerHTML = "";

    subjects.forEach(sub => {
      sub.subtopics.forEach(st => {
        if (st.completed && st.revisions) {
          st.revisions.forEach(r => {
            if (!r.done) { // ‚úÖ only show not done
              if (r.date===today) {
                todayContainer.innerHTML += `
                  <div class="revision-card card p-2 d-flex justify-content-between flex-row align-items-center">
                    ${sub.name} - ${st.name}
                    <button class="btn btn-sm btn-success" onclick="markRevisionDone(${sub.id},${st.id},'${r.date}')">Mark Done</button>
                  </div>`;
              } else if (r.date<today) {
                missedContainer.innerHTML += `
                  <div class="revision-card card p-2 bg-warning-subtle">
                    ${sub.name} - ${st.name} (Missed on ${r.date})
                  </div>`;
              }
            }
          });
        }
      });
    });

    Object.keys(revisionHistory).sort().forEach(date => {
      const div = document.createElement("div");
      div.className = "mb-2";
      div.innerHTML = `<strong>${date}</strong><ul>${revisionHistory[date].map(item=>`<li>${item.subject} - ${item.subtopic}</li>`).join("")}</ul>`;
      historyContainer.appendChild(div);
    });
  }

  function renderAll() {
    renderSubjects();
    renderDailyLog();
    renderStopwatchLog();
    renderRevision();
  }

  // Export JSON
  function exportData() {
    const data = {subjects, dailyLog, revisionHistory, stopwatchLog};
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "study_tracker_data.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  // Import JSON
  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        subjects = data.subjects || [];
        dailyLog = data.dailyLog || {};
        revisionHistory = data.revisionHistory || {};
        stopwatchLog = data.stopwatchLog || {};
        saveData();
        renderAll();
        alert("Data imported successfully!");
      } catch {
        alert("Invalid JSON file");
      }
    };
    reader.readAsText(file);
  }

  // Reset All
  function resetData() {
    if (confirm("Are you sure you want to reset all data?")) {
      subjects=[]; dailyLog={}; revisionHistory={}; stopwatchLog={};
      saveData();
      renderAll();
    }
  }
  // ====== Online Sync with JSONBin.io ======

  // Replace with your JSONBin details
  const BIN_ID = "68a80f4f43b1c97be92520b6"; // <- get from jsonbin dashboard
  const API_KEY = "$2a$10$x7iYQ5v/L.Y209vLI6g.k.EHLjFVR//Ogd8os5wea1kt87j8guB9m";
  const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

  async function saveOnline() {
    const data = {subjects, dailyLog, revisionHistory, stopwatchLog};
    try {
      await fetch(API_URL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": API_KEY
        },
        body: JSON.stringify(data)
      });
      alert("‚úÖ Data saved to cloud!");
    } catch (err) {
      console.error(err);
      alert("‚ùå Failed to save online");
    }
  }

  async function loadOnline() {
    try {
      const res = await fetch(API_URL, {
        headers: { "X-Master-Key": API_KEY }
      });
      const json = await res.json();
      if (json.record) {
        subjects = json.record.subjects || [];
        dailyLog = json.record.dailyLog || {};
        revisionHistory = json.record.revisionHistory || {};
        stopwatchLog = json.record.stopwatchLog || {};
        saveData();
        renderAll();
        alert("‚òÅÔ∏è Data loaded from cloud!");
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå Failed to load online");
    }
  }

  // Auto-save before tab close
  window.addEventListener("beforeunload", function (e) {
    saveOnline();
    e.preventDefault();
    e.returnValue = "Do you want to save before leaving?";
  });


  loadOnline().then(() => renderAll());

</script>
</body>
</html>
